<!doctype html>
<html lang="en">
  <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Lucy H | OS in Rust</title>
        <link rel="stylesheet" href="../../../css/main.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
        <!-- and it's easy to individually load additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/languages/scheme.min.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/base16/onedark.min.css">
        <script>hljs.highlightAll();</script>

        <link rel="preconnect" href="https://www.googletagmanager.com" />
        <link rel="preconnect" href="https://www.google-analytics.com" />

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-KDGPVMHC9Q"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-KDGPVMHC9Q');
        </script>

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@hoalycu" />
        <meta name="twitter:creator" content="@hoalycu" />
        <meta property="og:title" content="OS in Rust" />
        
        
        <meta property="og:url" content="/posts/notes/os" />
        
        

        <!-- basic favicon -->
        <link rel="icon" href="../../../images/android-chrome-384x384.png" /> 
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../images/android-chrome-384x384.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../../images/android-chrome-384x384.png">
        <link rel="apple-touch-icon-precomposed" href="../../../images/android-chrome-384x384.png">
    </head>


        <body>
        <header>
            <div class="logo">
                <a href="../../../">
                <img src="../../../images/android-chrome-384x384.png" alt="Me">
                </a>
            </div>
        </header>

        <main role="main">
            <h1>OS in Rust</h1>
            <div>
  
    <div class="header">
        Posted on May 23, 2022
        
    </div>
<div class="tags">
    
    Tags: <a title="All pages tagged 'operating systems'." href="../../../tags/operating%20systems/index.html">operating systems</a>
    
</div>
    <div>
        <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_freestanding_rust_binary">freestanding rust binary</a></li>
<li><a href="#_a_minimal_rust_kernel">a minimal rust kernel</a></li>
<li><a href="#_vga_buffer">vga buffer</a></li>
<li><a href="#_testing">Testing</a></li>
<li><a href="#_cpu_exceptions">CPU Exceptions</a></li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://os.phil-opp.com/" class="bare">https://os.phil-opp.com/</a></p>
</div>
<div class="sect1">
<h2 id="_freestanding_rust_binary">freestanding rust binary</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>use of <code>#![no_std]</code> because the standard library requires <code>libc</code> which requires the operating system and because features like files, networking and threads (part of standard library) require the operating system.</p>
</li>
<li>
<p><code>#[panic_handler]</code>: must define a function to run when panic occurs</p>
</li>
<li>
<p>language item: special functions and types that are required internally by the compiler</p>
<div class="ulist">
<ul>
<li>
<p><code>eh_personality</code>: marks a function that is used for stack unwinding</p>
</li>
<li>
<p>Rust use unwinding to ensure all memory freed on panic</p>
</li>
<li>
<p>disabling unwinding reduces binary size</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://www.nongnu.org/libunwind/" class="bare">https://www.nongnu.org/libunwind/</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/debug/structured-exception-handling" class="bare">https://docs.microsoft.com/en-us/windows/win32/debug/structured-exception-handling</a></p>
</li>
<li>
<p><a href="https://www.bogotobogo.com/cplusplus/stackunwinding.php" class="bare">https://www.bogotobogo.com/cplusplus/stackunwinding.php</a></p>
</li>
<li>
<p><code>start</code> attribute: the first program that runs is the runtime system, which is called before <code>main</code></p>
<div class="ulist">
<ul>
<li>
<p>in a Rust binary that links stdlib ‚áí calls <code>crt0</code> ‚áí creating a stack and placing right arguments there</p>
</li>
<li>
<p>C runtime invokes entry point of Rust runtime, which is marked by <code>start</code> language item ‚áí Rust runtime then calls <code>main</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>we don‚Äôt have access to Rust runtime and <code>crt0</code> ‚áí need to overwrite <code>crt0</code> entry point ‚áí add <code>#![no_main]</code> and add own `<em>start</em> function</p>
<div class="ulist">
<ul>
<li>
<p><code>extern "C"</code>: tells compiler to use C calling convention</p>
</li>
<li>
<p><code>!</code>: return type means the function is diverging, never allowed to return</p>
</li>
</ul>
</div>
</li>
<li>
<p>linker: program that combines generated code into executable</p>
<div class="ulist">
<ul>
<li>
<p>to avoid error, we must compile for a different environment with no underlying os ‚áí bare-metal</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_minimal_rust_kernel">a minimal rust kernel</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>when you turn on computer ‚áí begins executing firmware code stored in motherboard ROM ‚áí code performs power-on self-test, detects available RAM ‚áí pre-inits CPU and hardware ‚áí looks for bootable disk and starts booting os kernel</p>
</li>
<li>
<p>BIOS: basic input/output system</p>
</li>
<li>
<p>UEFI: unified extensible firmware interface</p>
</li>
<li>
<p>BIOS Boot: almost all x86 systems have support for BIOS.</p>
<div class="ulist">
<ul>
<li>
<p>CPU is put into a 16-bit compatibility mode called real mode before booting so old bootloaders would still work</p>
</li>
</ul>
</div>
</li>
<li>
<p>turn on computer ‚áí loads BIOS ‚áí self test and init routines ‚áí look for bootable disks ‚áí control transferred to bootloader ‚áí determine location of kernel image on disk and load into memory ‚áí switch CPU from 16-bit real mode to 32-bit protected mode then 64-bit long mode (64-bit registers and complete main memory are avail) ‚áí query information from BIOS and pass to OS</p>
<div class="ulist">
<ul>
<li>
<p>real mode: addresses in real mode actually correspond to real locations in memory</p>
</li>
<li>
<p>protected mode: allow to use virtual memory, paging, safe multi-tasking</p>
</li>
<li>
<p>long mode: access to 64-bit instructions and registers</p>
</li>
</ul>
</div>
</li>
<li>
<p>multiboot standard: GNU GRUB</p>
<div class="ulist">
<ul>
<li>
<p>to make kernel Multiboot compliant, insert Multiboot header at beginning of file</p>
</li>
<li>
<p>designed to make bootloader simple instead of kernel ‚áí kernel needs to be linked with adjusted default page size because GRUB can‚Äôt find Multiboot header otherwise</p>
</li>
<li>
<p>boot information: contains lots of architecture dependent structures instead of ocean abstraction</p>
</li>
</ul>
</div>
</li>
<li>
<p>redzone is disabled because it could cause stack corruptions when dealing with interrupts</p>
<div class="ulist">
<ul>
<li>
<p>allows functions to temporally use the 128 bytes below its stack frame without adjusting the stack pointer</p>
</li>
<li>
<p>on exceptions or hardware interrupts, the red zone is overwritten</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>"features": "-mmx,-sse,+soft-float",</code>: <code>mmx</code> and <code>sse</code> features determine support for SIMD, which can speed up programs significantly</p>
<div class="ulist">
<ul>
<li>
<p>performance problems: the kernel has to restore all registers to their original state before continuing an interrupted program</p>
</li>
<li>
<p>for every interrupt, the complete SIMD state has to be saved</p>
</li>
</ul>
</div>
</li>
<li>
<p>memory-related intrinsics: memory-related functions in the <code>compiler_builtins</code> crate that aren‚Äôt enabled by default because they normally are provided by the C library</p>
<div class="ulist">
<ul>
<li>
<p>can‚Äôt link to the C library so we could: implement our own functions</p>
</li>
<li>
<p>enable the implementations provided by the crate</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vga_buffer">vga buffer</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>'static</code> lifetime: says reference is valid for whole program run</p>
</li>
<li>
<p><code>repr¬©</code>: Rust lays out structs like C (field ordering in default structs is undefined in Rust)</p>
</li>
<li>
<p><code>repr(transparent)</code>: same memory layout for single field</p>
</li>
<li>
<p>compiler optimization: compiler doesn‚Äôt know we access VGA Buffer Memory and doesn‚Äôt know about the side effects of printing, so it might decide these writes are not needed, and omit them</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>can‚Äôt use <code>test</code> create because it relies on the standard library</p>
</li>
<li>
<p>can replace default test framework with the <code>custome_test_frameworks</code> feature</p>
<div class="ulist">
<ul>
<li>
<p>collects all functions with <code>#[test_case]</code> and invokes user-specified runner function with list of tests as arguments</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cpu_exceptions">CPU Exceptions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>to respond to CPU exceptions ‚áí set up interrupt handler descriptor table that has handler functions</p>
</li>
<li>
<p>on x86 there are about 20 different exceptions. the most important ones are: page fault, invalid opcode, general protection fault, double fault (fault occurs while calling the exception handler or there is no handler function registered for that exception), triple fault (CPU tries to double fault handler function. cannot catch or handle a triple fault, so most processors reboot + restart the OS)</p>
<div class="ulist">
<ul>
<li>
<p>hardware uses the table directly, each has the following 16-byte structure</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Cell in column 1, header row</th>
<th class="tableblock halign-left valign-top">Cell in column 2, header row</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 1, row 2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 2, row 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 1, row 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 2, row 3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 1, row 4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cell in column 2, row 4</p></td>
</tr>
</tbody>
</table>
</div>
</div>

    </div>
    <p><a href="../../../archive/">‚óÄ Back to posts</a></p>
</div>

        </main>
        
        <footer>
<center><p><a href="https://twitter.com/hoalycu" target="_blank">twitter</a> <a href="https://github.com/lhao03" target="_blank">github</a> <a href="https://www.linkedin.com/in/lucy-hao/" target="_blank">linkedin</a></p></center>
            Site powered by cats, üç´ and 
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
